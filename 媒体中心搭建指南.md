# 项目背景与媒体中心搭建指南

本文档是对项目主 README 的补充，聚焦为什么选择 Seedr.cc 作为云端下载中转，及在 Fedora + Jellyfin + Kodi 环境下搭建高质量媒体中心的可操作步骤与排错经验。

---

## 1. 为什么选择 Seedr（云端离线下载）

### 1.1 核心痛点

- 许多网络环境（校园网、公司网、公共 Wi‑Fi）对 P2P 流量有限制或屏蔽，导致 BT 下载速度极慢或无法连接。
- 在家用网络环境中，运营商可能对 P2P 做限速或封堵。

这些限制会让传统 qBittorrent/Transmission 等 P2P 下载在很多场景下不可用。

### 1.2 Seedr 的解决思路

采用“云端离线下载”策略：

1. 本地脚本把磁力提交给 Seedr（通过 HTTPS API）。
2. Seedr 在其数据中心完成 P2P 下载（高速、稳定）。
3. 下载完成后，脚本通过 Seedr 提供的 HTTP 下载链接把文件取回本地（无需本地 P2P）。

优点：绕过本地 P2P 限制，下载稳定且速度快；无须开端口或依赖本地网络质量。

安全注意：Seedr 存储你的文件与种子任务，账户凭据应妥善保管，`config.json` 中的凭据请保存在本地且加入 `.gitignore`。

---

## 2. 总体架构（示意）

- search_torrents.py → 发现新集并写入 `search_results.json`
- download_bt.py → 登录 Seedr、上传磁力、等待完成、下载到 `anime/`、更新 `download_history.json`
- Jellyfin（媒体服务器）或直接用 Samba 共享供 Kodi 访问

实战中我们在服务器上运行 Jellyfin（提供 Web UI），但由于 Flatpak + Tailscale 环境下，Kodi 的 Jellyfin 插件在本环境中存在兼容问题，最终采用 Samba 直接共享媒体目录给 Kodi。

---

## 3. 在 Fedora 上配置媒体共享（推荐：Samba）

下面假设媒体目录为：`/home/xjz/workplace/bangmi/anime`。

### 3.1 安装 Samba

```bash
sudo dnf install -y samba
```

### 3.2 编辑 Samba 配置

在 `/etc/samba/smb.conf` 的 `[global]` 段后添加共享：

```ini
[Anime]
   comment = Anime Media Share
   path = /home/xjz/workplace/bangmi/anime
   read only = yes
   guest ok = no
   browsable = yes
   writable = no
```

确保每个配置项在单独的一行，不要把注释写在同一行。

### 3.3 创建 Samba 用户与密码

用户需要是系统用户（例如 `xjz`），然后为 Samba 添加密码：

```bash
sudo smbpasswd -a xjz
```

### 3.4 启动并启用 Samba 服务

```bash
sudo systemctl enable --now smb.service
sudo systemctl enable --now nmb.service
```

### 3.5 SELinux: 允许共享家目录并设置上下文

如果系统开启了 SELinux，需要允许 Samba 访问家目录并修正目录上下文：

```bash
sudo setsebool -P samba_enable_home_dirs on
sudo setsebool -P allow_samba_user_share on
sudo restorecon -Rv /home/xjz/workplace/bangmi/anime
```

如果 Samba 仍然无法访问，请检查 `ausearch -m avc -ts recent` 或 `journalctl -e` 中的 SELinux 拒绝消息。

### 3.6 防火墙（如果启用 firewalld）

允许 Samba 服务或给 Tailscale 接口放通：

```bash
sudo firewall-cmd --add-service=samba --permanent
sudo firewall-cmd --reload
# 或者允许特定接口（示例：tailscale0）
sudo firewall-cmd --zone=trusted --add-interface=tailscale0 --permanent
sudo firewall-cmd --reload
```

---

## 4. Kodi 端配置与画质（缩放）优化

在 Kodi 中直接挂载 SMB 源（路径示例）：

- 协议：Windows 网络 (SMB)
- 服务器：`100.117.113.106`（你的 Tailscale IP）
- 共享名：`Anime`
- 用户/密码：在第 3.3 步设置的 Samba 用户

添加为视频源并设置内容类型为 TV 剧集。

### 4.1 关键画质设置（放大算法）

在 Kodi 播放时：

1. 打开“播放控件” → 进入“视频设置”。
2. 找到 “Video scaling method”（视频缩放/采样方式）。
3. 将其从默认（通常为 Bilinear）改为 `Lanczos3-optimized` 或 `Lanczos`。

Lanczos 系列算法在将 1080p 放大到 4K 时能保留更多细节，显著改善模糊问题。

（提示）可将该设置设为所有媒体的默认值以免每次手动切换。

---

## 5. 常见问题与排查建议

- **Jellyfin 插件在 Kodi 上不显示媒体**：Flatpak + Tailscale 的组合可能导致插件无法访问底层文件路径。推荐绕过插件直接使用 Samba 或让 Jellyfin 作为备份索引工具而不作为 Kodi 的主数据源。
- **权限错误（无法读取文件）**：检查文件所有权与权限，确保 `User`（运行 Kodi 或 Samba 的账号）对 `/home/xjz/workplace/bangmi/anime` 有读取权限：

```bash
sudo chown -R xjz:xjz /home/xjz/workplace/bangmi/anime
sudo chmod -R 755 /home/xjz/workplace/bangmi/anime
```

- **SELinux 拒绝访问**：使用 `ausearch -m avc -ts today` 或 `journalctl -t setroubleshoot` 查看拒绝日志，按需调整 `setsebool` 或 `restorecon`。
- **防火墙阻断**：使用 `sudo firewall-cmd --list-all` 检查区域与接口绑定。

---

## 6. 安全与运维小贴士

- `config.json` 包含 Seedr/服务凭据，已加入 `.gitignore`，不要将其上传到公开仓库。备份真实配置为 `config.json.local`（仅本地保存）。
- 定期清理 `anime/` 中的旧文件以节省磁盘，或配置 Jellyfin 的自动清理规则。
- 对于自动运行的 `bangmi_scheduler.py`，建议使用 systemd（已在主 README 给出示例），并把日志输出到 `scheduler.log` 以便排错。

---

## 7. 常用命令速查

```bash
# Samba 安装与启动
sudo dnf install -y samba
sudo systemctl enable --now smb.service nmb.service

# 检查 SELinux 的相关布尔值
sestatus
sudo getsebool -a | grep samba

# 修改目录上下文
sudo restorecon -Rv /home/xjz/workplace/bangmi/anime

# 查看 Samba 状态与日志
sudo systemctl status smb.service
sudo journalctl -u smb.service -n 200 --no-pager

# Kodi 上测试播放（客户端）: 通过 GUI 添加 SMB 源
```
